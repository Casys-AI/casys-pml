<story-context id="1-5-idempotent-init-helper" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Idempotent Init Helper</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-5-idempotent-init-helper.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>notebook author</asA>
    <iWant>a helper that ensures the playground is ready</iWant>
    <soThat>each notebook can be run independently without manual setup</soThat>
    <tasks>
      <task id="1" ac="1"
      >Create init module structure - playground/lib/init.ts with InitOptions and InitStatus interfaces</task>
      <task id="2" ac="2"
      >Implement initialization state detection - Check PGlite DB, embeddings table, MCP connections</task>
      <task id="3" ac="3"
      >Implement full initialization flow - MCP connect, workflows sync, embeddings generation</task>
      <task id="4" ac="4"
      >Implement skip logic - Early return in &lt;100ms when already initialized</task>
      <task id="5" ac="5">Implement verbose mode - Detailed logging for notebook 00</task>
      <task id="6" ac="6"
      >Implement status return - { initialized, mcpServers, workflowsLoaded }</task>
      <task id="7" ac="1-6"
      >Add unit tests - Fresh init, skip test, verbose test, status structure</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">playground/lib/init.ts exporte ensurePlaygroundReady(options?)</criterion>
    <criterion id="2">Verifie si deja initialise (PGlite DB exists, embeddings loaded)</criterion>
    <criterion id="3">Si non initialise → run full init (MCP connect, workflows sync)</criterion>
    <criterion id="4">Si deja initialise → skip rapidement (&lt; 100ms)</criterion>
    <criterion id="5"
    >Option verbose: true pour afficher le detail (utilise dans notebook 00)</criterion>
    <criterion id="6"
    >Retourne status { initialized: boolean, mcpServers: string[], workflowsLoaded: number }</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD-playground.md</path>
        <title>Casys MCP Gateway Playground PRD</title>
        <section>Functional Requirements</section>
        <snippet
        >FR001: Le playground doit s'executer dans un GitHub Codespace. FR002: L'initialisation doit supporter agentcards init. NFR001: Temps de setup &lt; 5 minutes.</snippet>
      </doc>
      <doc>
        <path>docs/epics-playground.md</path>
        <title>Epic Breakdown Playground</title>
        <section>Story 1.5: Idempotent Init Helper</section>
        <snippet
        >Helper idempotent pour eviter re-initialisation couteuse. Support verbose pour notebook 00. Depends on stories 1.2, 1.3, 1.4.</snippet>
      </doc>
      <doc>
        <path>docs/adrs/ADR-021-configurable-database-path.md</path>
        <title>ADR-021: Configurable Database Path</title>
        <section>Environment Variable</section>
        <snippet
        >AGENTCARDS_DB_PATH env var for Codespace persistence. Default: ~/.agentcards/.agentcards.db</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>playground/lib/llm-provider.ts</path>
        <kind>module</kind>
        <symbol>detectProvider, createLLM, generateCompletion</symbol>
        <lines>1-129</lines>
        <reason
        >Pattern for Deno module structure, exports at top, types, implementation. Use similar structure for init.ts</reason>
      </file>
      <file>
        <path>playground/lib/viz.ts</path>
        <kind>module</kind>
        <symbol>DAGTask, DAGWorkflow, ToolEdge, ExecutionEvent</symbol>
        <lines>1-50</lines>
        <reason>Pattern for TypeScript interfaces and complex type definitions</reason>
      </file>
      <file>
        <path>src/db/client.ts</path>
        <kind>service</kind>
        <symbol>PGliteClient.connect()</symbol>
        <lines>47-76</lines>
        <reason
        >Database initialization pattern - connect(), check existence, create extension. Reuse for isAlreadyInitialized()</reason>
      </file>
      <file>
        <path>src/cli/utils.ts</path>
        <kind>utility</kind>
        <symbol>getAgentCardsDatabasePath()</symbol>
        <lines>49+</lines>
        <reason>Get DB path with AGENTCARDS_DB_PATH env var support - MUST import and reuse</reason>
      </file>
      <file>
        <path>src/mcp/gateway-server.ts</path>
        <kind>service</kind>
        <symbol>GatewayServerConfig, MCPClient</symbol>
        <lines>1-80</lines>
        <reason>MCP connection patterns, server initialization flow</reason>
      </file>
      <file>
        <path>config/workflow-templates.yaml</path>
        <kind>config</kind>
        <symbol>workflows sync format</symbol>
        <lines>1-60</lines>
        <reason>Workflow template format for sync operation</reason>
      </file>
      <file>
        <path>playground/scripts/setup-api-key_test.ts</path>
        <kind>test</kind>
        <symbol>Deno.test patterns</symbol>
        <lines>all</lines>
        <reason>Test file structure pattern for playground tests</reason>
      </file>
    </code>
    <dependencies>
      <deno>
        <package name="@electric-sql/pglite" version="0.3.11">PGlite database</package>
        <package name="@std/fs" version="1.0.19">File system utilities (ensureDir)</package>
        <package name="@std/log" version="0.224.14">Logging</package>
        <package name="@std/yaml" version="1.0.10">YAML parsing for workflow templates</package>
      </deno>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance"
    >Skip time MUST be &lt; 100ms when already initialized</constraint>
    <constraint type="pattern"
    >Use same module structure as llm-provider.ts: exports at top, types, then implementation</constraint>
    <constraint type="pattern"
    >Use colored output with status indicators: checkmark for success, X for error, warning for partial</constraint>
    <constraint type="pattern"
    >Create separate _test.ts file following setup-api-key_test.ts patterns</constraint>
    <constraint type="integration"
    >Import getAgentCardsDatabasePath from src/cli/utils.ts - DO NOT recreate</constraint>
    <constraint type="integration"
    >Use PGliteClient patterns from src/db/client.ts for DB checks</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>InitOptions</name>
      <kind>TypeScript interface</kind>
      <signature>interface InitOptions { verbose?: boolean; configPath?: string; }</signature>
      <path>playground/lib/init.ts (to create)</path>
    </interface>
    <interface>
      <name>InitStatus</name>
      <kind>TypeScript interface</kind>
      <signature
      >interface InitStatus { initialized: boolean; mcpServers: string[]; workflowsLoaded: number; error?: string; }</signature>
      <path>playground/lib/init.ts (to create)</path>
    </interface>
    <interface>
      <name>ensurePlaygroundReady</name>
      <kind>async function</kind>
      <signature
      >export async function ensurePlaygroundReady(options?: InitOptions): Promise&lt;InitStatus&gt;</signature>
      <path>playground/lib/init.ts (to create)</path>
    </interface>
    <interface>
      <name>isAlreadyInitialized</name>
      <kind>async function (internal)</kind>
      <signature>async function isAlreadyInitialized(): Promise&lt;boolean&gt;</signature>
      <path>playground/lib/init.ts (to create)</path>
    </interface>
  </interfaces>

  <tests>
    <standards
    >Deno.test with descriptive names. Use assertEquals, assertExists from @std/assert. Separate unit and integration tests. Mock file system for unit tests.</standards>
    <locations>
      <location>playground/lib/init_test.ts</location>
      <location>tests/unit/playground/ (if needed for deeper unit tests)</location>
    </locations>
    <ideas>
      <idea ac="1">Test ensurePlaygroundReady exports correctly and accepts options</idea>
      <idea ac="2">Test isAlreadyInitialized returns true when DB and embeddings exist</idea>
      <idea ac="2">Test isAlreadyInitialized returns false when DB missing</idea>
      <idea ac="3">Test full init flow creates DB and syncs workflows (integration)</idea>
      <idea ac="4">Test skip time &lt; 100ms when already initialized (performance)</idea>
      <idea ac="5">Test verbose mode outputs expected log messages</idea>
      <idea ac="6">Test return status has correct structure and values</idea>
      <idea ac="3">Test partial failure handling (MCP connect fails, workflows succeed)</idea>
    </ideas>
  </tests>
</story-context>
