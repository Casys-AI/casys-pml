# Sandbox Security Audit Report

**Project:** Casys PML **Component:** Deno Sandbox Executor **Audit Date:** 2025-11-24 **Auditor:**
BMad Development Team **Epic:** Epic 3 - Agent Code Execution & Local Processing **Story:** Story
3.9 - Sandbox Security Hardening

---

## Executive Summary

This security audit evaluates the Casys PML Deno sandbox executor implementation against industry
security standards and identifies potential attack vectors. The sandbox provides **strong
foundational security** through Deno's permission model, but requires **hardening in input
validation, resource monitoring, and attack surface testing** before production deployment.

**Risk Assessment:**

- **Current Status:** Medium-High Risk (Missing critical input validation)
- **Post-Hardening:** Low Risk (Production-ready with comprehensive controls)
- **Recommendation:** MUST complete hardening before production (flagged as CRITICAL in Epic 2.5
  retrospective)

---

## 1. Security Architecture Review

### 1.1 Security Model

The Casys PML sandbox uses **defense-in-depth** with multiple security layers:

1. **Process Isolation:** Deno subprocess with separate memory space
2. **Permission Model:** Explicit allow-list, deny-by-default
3. **Resource Limits:** Timeout and memory constraints
4. **Error Sanitization:** Path and state information redaction
5. **JSON-Only Communication:** No code serialization

**Security Boundary:**

```
┌─────────────────────────────────────────┐
│  Parent Process (Casys PML MCP Server) │
│  - Trusted code                         │
│  - Full permissions                     │
└─────────────┬───────────────────────────┘
              │ JSON messages only
              │ (no code transfer)
┌─────────────▼───────────────────────────┐
│  Deno Sandbox Subprocess                │
│  - Untrusted agent code                 │
│  - Restricted permissions               │
│  - Resource limits enforced             │
│  - Isolated memory space                │
└─────────────────────────────────────────┘
```

### 1.2 Permission Configuration (Current)

**Allowed Permissions:**

- `--allow-read=<temp-file>[,<optional-paths>]` - Whitelist-only read access
- No write, network, subprocess, FFI, or env access by default

**Denied Permissions (Explicit):**

- `--deny-write` - No filesystem writes anywhere
- `--deny-net` - No network access (HTTP, WebSocket, DNS)
- `--deny-run` - No subprocess spawning
- `--deny-ffi` - No native code execution
- `--deny-env` - No environment variable access

**Resource Limits:**

- Timeout: 30s default (configurable)
- Memory: 512MB heap (V8 flag: `--max-old-space-size`)
- File cleanup: Automatic temp file removal

**Evaluation:** ✅ **STRONG** - Good foundational security model

---

## 2. Threat Model & Attack Vectors

### 2.1 Threat Actors

| Actor                    | Motivation                           | Capability                            | Likelihood |
| ------------------------ | ------------------------------------ | ------------------------------------- | ---------- |
| **Malicious Agent Code** | System compromise, data exfiltration | Generated by LLM, executed in sandbox | HIGH       |
| **Buggy Agent Code**     | Unintentional resource exhaustion    | Infinite loops, memory leaks          | HIGH       |
| **Exploit Developer**    | Sandbox escape, privilege escalation | Advanced knowledge of Deno internals  | LOW        |
| **Insider Threat**       | Intentional configuration weakening  | Access to configuration files         | LOW        |

### 2.2 Attack Surface Analysis

#### 2.2.1 Filesystem Attacks

| Attack Vector               | Description                | Current Mitigation             | Status          |
| --------------------------- | -------------------------- | ------------------------------ | --------------- |
| **Path Traversal**          | `../../../../etc/passwd`   | Deno permission check          | ✅ MITIGATED    |
| **Symlink Exploitation**    | Symlink to sensitive file  | Deno permission check          | ✅ MITIGATED    |
| **Disk Exhaustion**         | Write large files          | --deny-write                   | ✅ MITIGATED    |
| **Temp File Race (TOCTOU)** | Race on temp file          | Single-use temp files          | ✅ MITIGATED    |
| **Read Path Minimization**  | Over-permissive read paths | Currently allows full temp dir | ⚠️ NEEDS REVIEW |

**Recommendation:** Review and minimize `allowedReadPaths` to principle of least privilege

#### 2.2.2 Network Attacks

| Attack Vector        | Description                      | Current Mitigation      | Status       |
| -------------------- | -------------------------------- | ----------------------- | ------------ |
| **HTTP/HTTPS Fetch** | `fetch("https://evil.com")`      | --deny-net              | ✅ MITIGATED |
| **WebSocket**        | `new WebSocket("ws://...")`      | --deny-net              | ✅ MITIGATED |
| **DNS Exfiltration** | DNS lookup for data leakage      | --deny-net (blocks DNS) | ✅ MITIGATED |
| **Localhost Access** | `fetch("http://localhost:8080")` | --deny-net              | ✅ MITIGATED |

**Status:** ✅ **EXCELLENT** - Network completely blocked

#### 2.2.3 Resource Exhaustion Attacks

| Attack Vector            | Description                   | Current Mitigation    | Status       |
| ------------------------ | ----------------------------- | --------------------- | ------------ |
| **CPU Bomb**             | `while(true){}` infinite loop | Timeout (30s)         | ⚠️ PARTIAL   |
| **Memory Bomb**          | Large array allocation        | V8 heap limit (512MB) | ⚠️ PARTIAL   |
| **Fork Bomb**            | Infinite subprocess spawning  | --deny-run            | ✅ MITIGATED |
| **Disk I/O Abuse**       | Excessive read operations     | None                  | ❌ MISSING   |
| **Concurrent Execution** | Spawn 1000s of sandboxes      | None                  | ❌ MISSING   |

**Critical Gaps:**

- ❌ No CPU usage monitoring (cannot detect CPU bombs before timeout)
- ❌ No memory pressure detection (OOM happens abruptly)
- ❌ No disk I/O quotas (reads can thrash filesystem)
- ❌ No concurrent execution limits (DoS via parallel sandboxes)

#### 2.2.4 Code Injection Attacks

| Attack Vector            | Description                   | Current Mitigation       | Status       |
| ------------------------ | ----------------------------- | ------------------------ | ------------ |
| **eval() Usage**         | `eval("malicious code")`      | None                     | ❌ MISSING   |
| **Function Constructor** | `new Function("code")()`      | None                     | ❌ MISSING   |
| **Prototype Pollution**  | `__proto__.polluted = true`   | Tool name validation     | ⚠️ PARTIAL   |
| **Template Injection**   | `` `${malicious}` ``          | None                     | ❌ MISSING   |
| **Context Pollution**    | Inject malicious context keys | Variable name validation | ✅ MITIGATED |

**Critical Gaps:**

- ❌ No validation to reject `eval()` or `Function()` in user code
- ❌ No sanitization of context objects for `__proto__` pollution
- ⚠️ Template literals not validated (but limited damage)

#### 2.2.5 Privilege Escalation Attacks

| Attack Vector              | Description                      | Current Mitigation       | Status            |
| -------------------------- | -------------------------------- | ------------------------ | ----------------- |
| **Subprocess Elevation**   | Spawn subprocess with sudo       | --deny-run               | ✅ MITIGATED      |
| **Deno Permission Bypass** | Exploit Deno bug to bypass perms | Deno runtime security    | ✅ ASSUMED SECURE |
| **Signal Hijacking**       | SIGKILL/SIGTERM handler abuse    | Process kill via SIGKILL | ✅ MITIGATED      |
| **Parent Memory Access**   | Read parent process memory       | OS process isolation     | ✅ MITIGATED      |

**Status:** ✅ **STRONG** - Well isolated at OS and Deno levels

#### 2.2.6 Information Leakage

| Attack Vector           | Description                   | Current Mitigation       | Status        |
| ----------------------- | ----------------------------- | ------------------------ | ------------- |
| **Stack Trace Paths**   | `/home/user/...` in errors    | `sanitizeStackTrace()`   | ✅ MITIGATED  |
| **Error Message Leaks** | Sensitive data in error text  | `sanitizeErrorMessage()` | ✅ MITIGATED  |
| **Timing Attacks**      | Infer data via execution time | None                     | ⚠️ ACCEPTABLE |
| **Internal State**      | Error reveals implementation  | Structured errors        | ✅ MITIGATED  |

**Status:** ✅ **GOOD** - Comprehensive error sanitization

---

## 3. Privilege Escalation Vector Analysis

### 3.1 Subprocess Isolation

**Mechanism:** Deno spawns subprocess using OS fork/exec **Memory Isolation:** Yes (separate address
space) **Signal Handling:** Parent can forcefully kill (SIGKILL) **Zombie Prevention:** Async wait
via `process.output()`

**Test Coverage:** ❌ **MISSING**

- No tests for parent process memory inaccessibility
- No tests for zombie process cleanup
- No tests for signal handling security

**Recommendation:** Add subprocess isolation tests (AC #6)

### 3.2 Deno Permission Bypass

**Risk:** Low (relies on Deno runtime bug) **Mitigation:**

- Use stable Deno LTS (2.2 LTS)
- Monitor Deno security advisories
- Defense-in-depth (multiple permission layers)

**Current Deno Version:** Requires verification **Recommendation:** Document Deno version policy and
update process

---

## 4. Security Test Coverage Analysis

### 4.1 Existing Test Coverage

**Unit Tests (tests/unit/sandbox/isolation_test.ts):**

- ✅ 15 isolation tests
- ✅ Filesystem read/write denial
- ✅ Network access denial (fetch, localhost)
- ✅ Subprocess spawning denial
- ✅ Environment variable denial
- ✅ FFI access denial
- ✅ Path traversal attacks

**E2E Tests (tests/e2e/code-execution/01-sandbox-isolation.test.ts):**

- ✅ 7 integration tests
- ✅ Timeout enforcement
- ✅ Error handling (syntax, runtime)

**Coverage Rating:** 65% (Good foundation, missing attack vectors)

### 4.2 Missing Test Coverage

❌ **Attack Vector Tests:**

- Privilege escalation attempts (sudo, setuid)
- Resource exhaustion (CPU bomb, memory bomb)
- Code injection (eval, Function, **proto**)
- Concurrent execution stress tests

❌ **Subprocess Security:**

- Parent memory isolation verification
- Zombie process prevention
- Signal handling security

❌ **Input Validation:**

- Malicious pattern detection
- Context object sanitization

**Recommendation:** Create `tests/security/` directory with comprehensive attack tests

---

## 5. Configuration Security Review

### 5.1 Default Configuration

Current defaults in `executor.ts:36-41`:

```typescript
const DEFAULTS = {
  TIMEOUT_MS: 30000, // 30 seconds
  MEMORY_LIMIT_MB: 512, // 512MB heap
  ALLOWED_READ_PATHS: [], // Empty (most secure)
};
```

**Evaluation:** ✅ **SECURE DEFAULTS**

### 5.2 Configuration Validation

**Current State:** ❌ **MISSING**

- No validation of timeout values (could set to 0 or MAX_INT)
- No validation of memory limits (could set to 1MB or 100GB)
- No validation of allowed read paths (could set to "/" root)

**Risk:** Medium (insider threat or misconfiguration)

**Recommendation:** Add configuration validation (AC #8):

```typescript
if (timeout < 100 || timeout > 600000) {
  throw new Error("Timeout must be between 100ms and 10min");
}
if (memoryLimit < 64 || memoryLimit > 2048) {
  throw new Error("Memory limit must be between 64MB and 2GB");
}
```

---

## 6. Recommendations & Remediation

### 6.1 Critical (MUST FIX before production)

| ID         | Issue                                      | Severity | AC | Effort |
| ---------- | ------------------------------------------ | -------- | -- | ------ |
| **SEC-01** | Missing input validation (eval, Function)  | CRITICAL | #2 | 2h     |
| **SEC-02** | No context object sanitization (**proto**) | HIGH     | #2 | 1h     |
| **SEC-03** | No concurrent execution limits             | HIGH     | #4 | 2h     |
| **SEC-04** | Missing configuration validation           | HIGH     | #8 | 1h     |

### 6.2 High Priority (Production readiness)

| ID         | Issue                         | Severity | AC | Effort |
| ---------- | ----------------------------- | -------- | -- | ------ |
| **SEC-05** | No CPU usage monitoring       | MEDIUM   | #4 | 3h     |
| **SEC-06** | No memory pressure detection  | MEDIUM   | #4 | 2h     |
| **SEC-07** | No disk I/O quotas            | MEDIUM   | #4 | 3h     |
| **SEC-08** | Missing penetration tests     | MEDIUM   | #5 | 4h     |
| **SEC-09** | No subprocess isolation tests | MEDIUM   | #6 | 2h     |

### 6.3 Medium Priority (Defense-in-depth)

| ID         | Issue                                | Severity | AC  | Effort |
| ---------- | ------------------------------------ | -------- | --- | ------ |
| **SEC-10** | Review allowedReadPaths minimization | LOW      | #3  | 1h     |
| **SEC-11** | Security documentation               | LOW      | #10 | 3h     |

---

## 7. Threat Mitigation Strategy

### 7.1 Input Validation Layer (SEC-01, SEC-02)

**Implementation:**

```typescript
class CodeValidator {
  private static DANGEROUS_PATTERNS = [
    /\beval\s*\(/,
    /\bFunction\s*\(/,
    /__proto__/,
    /constructor\s*\[/,
    /__defineGetter__/,
  ];

  static validate(code: string, context?: Record<string, unknown>): void {
    // Validate code
    for (const pattern of this.DANGEROUS_PATTERNS) {
      if (pattern.test(code)) {
        throw new SecurityError(`Malicious pattern detected: ${pattern}`);
      }
    }

    // Validate context for prototype pollution
    if (context) {
      this.sanitizeContext(context);
    }
  }

  private static sanitizeContext(obj: Record<string, unknown>): void {
    const dangerous = ["__proto__", "constructor", "prototype"];
    for (const key of Object.keys(obj)) {
      if (dangerous.includes(key)) {
        throw new SecurityError(`Dangerous context key: ${key}`);
      }
    }
  }
}
```

### 7.2 Resource Monitoring Layer (SEC-03, SEC-05, SEC-06)

**Concurrent Execution Limiter:**

```typescript
class SandboxPool {
  private activeCount = 0;
  private readonly maxConcurrent = 5;

  async acquire(): Promise<void> {
    if (this.activeCount >= this.maxConcurrent) {
      throw new ResourceLimitError("Max concurrent sandboxes reached");
    }
    this.activeCount++;
  }

  release(): void {
    this.activeCount--;
  }
}
```

**CPU Monitoring (Deferred):**

- Note: Direct CPU monitoring in Deno requires FFI or external process
- Mitigation: Rely on timeout for now, add CPU monitoring in Epic 4
- Alternative: Track execution time patterns for anomaly detection

### 7.3 Configuration Validation (SEC-04)

**Add to constructor:**

```typescript
constructor(config?: SandboxConfig) {
  // Validate timeout
  if (config?.timeout !== undefined) {
    if (config.timeout < 100 || config.timeout > 600000) {
      throw new ConfigError("Timeout must be 100ms-10min");
    }
  }

  // Validate memory limit
  if (config?.memoryLimit !== undefined) {
    if (config.memoryLimit < 64 || config.memoryLimit > 2048) {
      throw new ConfigError("Memory limit must be 64MB-2GB");
    }
  }

  // Validate read paths (no root, no sensitive dirs)
  if (config?.allowedReadPaths) {
    for (const path of config.allowedReadPaths) {
      if (path === "/" || path.startsWith("/etc/")) {
        throw new ConfigError(`Dangerous read path: ${path}`);
      }
    }
  }

  this.config = { ...DEFAULT_CONFIG, ...config };
}
```

---

## 8. Security Testing Strategy

### 8.1 Test Organization

Create `tests/security/` directory structure:

```
tests/security/
├── isolation_test.ts           # Filesystem, network, subprocess
├── attack_vectors_test.ts      # Escalation, breakout, bypass, exhaustion
├── input_validation_test.ts    # Malicious code, proto pollution
├── resource_limits_test.ts     # CPU, memory, disk, concurrent
└── subprocess_security_test.ts # Memory isolation, zombies, signals
```

### 8.2 Penetration Test Cases (SEC-08)

**Test Matrix:**

| Attack Type          | Test Case                     | Expected Result          |
| -------------------- | ----------------------------- | ------------------------ |
| Privilege Escalation | Attempt `sudo` command        | PermissionError          |
| Filesystem Breakout  | Read `../../../../etc/passwd` | PermissionError          |
| Network Bypass       | `fetch("https://evil.com")`   | PermissionError          |
| CPU Exhaustion       | Infinite loop                 | TimeoutError (30s)       |
| Memory Bomb          | Allocate 1GB array            | MemoryError              |
| Fork Bomb            | Spawn 1000 subprocesses       | PermissionError          |
| eval() Injection     | `eval("malicious")`           | SecurityError (rejected) |
| Prototype Pollution  | `__proto__.x = 1`             | SecurityError (rejected) |

---

## 9. Production Checklist

### Before Production Deployment:

- [ ] **SEC-01:** Input validation implemented (eval, Function detection)
- [ ] **SEC-02:** Context sanitization implemented (**proto** prevention)
- [ ] **SEC-03:** Concurrent execution limits enforced
- [ ] **SEC-04:** Configuration validation added
- [ ] **SEC-05:** CPU monitoring OR timeout hardening
- [ ] **SEC-06:** Memory pressure detection
- [ ] **SEC-07:** Disk I/O monitoring
- [ ] **SEC-08:** Penetration tests passing (100%)
- [ ] **SEC-09:** Subprocess isolation tests passing
- [ ] **SEC-10:** Read paths minimized and documented
- [ ] **SEC-11:** Security documentation complete

### Production Readiness Criteria:

- ✅ All CRITICAL issues resolved
- ✅ All HIGH issues resolved or accepted
- ✅ Penetration tests achieve 100% pass rate
- ✅ Security test suite runs in CI/CD
- ✅ Security documentation published
- ✅ Incident response plan documented

---

## 10. Conclusion

**Current Security Posture:** MEDIUM-HIGH RISK **Post-Hardening Security Posture:** LOW RISK
(Production Ready)

The Casys PML sandbox executor has **strong foundational security** with excellent process
isolation and permission controls. However, **input validation gaps** (eval, Function, prototype
pollution) and **missing resource monitoring** (concurrent limits, CPU tracking) create attack
vectors that MUST be addressed before production.

**Estimated Hardening Effort:** 20-25 hours **Risk if Deployed Without Hardening:** HIGH (Code
injection, resource exhaustion possible) **Recommendation:** PROCEED with hardening tasks 2-9
immediately

**Sign-off:** This audit satisfies Story 3.9 AC #1 (Security Audit).

---

**Audit Version:** 1.0 **Next Review Date:** After Epic 3 completion or 6 months **Auditor:** BMad
Development Team **Approval Required:** Product Owner / Security Team
