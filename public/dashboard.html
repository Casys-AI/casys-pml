<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentCards - Graph Dashboard</title>

  <!-- Cytoscape.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.4/dist/cytoscape.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a1a;
      color: #fff;
      overflow: hidden;
    }

    #graph-container {
      width: 100vw;
      height: 100vh;
      background: #0d0d0d;
    }

    #legend {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
      max-height: 80vh;
      overflow-y: auto;
    }

    #legend h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #888;
      text-transform: uppercase;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .legend-item:hover {
      opacity: 0.7;
    }

    .legend-item.disabled {
      opacity: 0.4;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .legend-label {
      font-size: 13px;
    }

    #node-details {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.9);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #333;
      min-width: 300px;
      display: none;
    }

    #node-details.visible {
      display: block;
    }

    #node-details h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #0066cc;
    }

    #node-details p {
      font-size: 13px;
      margin: 5px 0;
      color: #ccc;
    }

    #node-details .neighbors {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #333;
    }

    #node-details .neighbor-tag {
      display: inline-block;
      background: #333;
      padding: 4px 8px;
      margin: 4px;
      border-radius: 4px;
      font-size: 11px;
    }

    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.95);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      display: none;
      z-index: 1000;
    }

    #tooltip.visible {
      display: block;
    }

    /* Highlight animation */
    .highlight {
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      #legend {
        top: auto;
        bottom: 20px;
        right: 20px;
        max-width: calc(100vw - 40px);
      }

      #node-details {
        bottom: auto;
        top: 20px;
        left: 20px;
        right: 20px;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div id="graph-container"></div>

  <div id="legend">
    <h3>MCP Servers</h3>
    <!-- Legend items populated dynamically -->
  </div>

  <div id="node-details">
    <h3 id="detail-title">Node Details</h3>
    <p><strong>Server:</strong> <span id="detail-server"></span></p>
    <p><strong>PageRank:</strong> <span id="detail-pagerank"></span></p>
    <p><strong>Connections:</strong> <span id="detail-degree"></span></p>
    <div class="neighbors">
      <strong>Connected Tools:</strong>
      <div id="detail-neighbors"></div>
    </div>
  </div>

  <div id="tooltip"></div>

  <script>
    // Server color mapping
    const SERVER_COLORS = {
      'filesystem': '#3498db',
      'postgres': '#9b59b6',
      'github': '#2ecc71',
      'brave-search': '#e74c3c',
      'agentcards': '#f39c12',
      'memory': '#e67e22',
      'fetch': '#1abc9c',
      'sequential-thinking': '#34495e',
      'serena': '#16a085',
      'context7': '#8e44ad'
    };

    function getServerColor(server) {
      return SERVER_COLORS[server] || '#95a5a6'; // Default gray
    }

    // Initialize Cytoscape instance
    const cy = cytoscape({
      container: document.getElementById('graph-container'),

      // Initial empty graph
      elements: [],

      // Styling
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'width': 'data(size)',
            'height': 'data(size)',
            'background-color': 'data(color)',
            'border-width': 2,
            'border-color': '#666',
            'font-size': 10,
            'text-valign': 'center',
            'text-halign': 'center',
            'color': '#fff',
            'text-outline-width': 2,
            'text-outline-color': '#000'
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 'data(weight)',
            'line-color': '#ccc',
            'target-arrow-color': '#ccc',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'opacity': 'data(opacity)'
          }
        },
        {
          selector: 'node:selected',
          style: {
            'border-color': '#0066cc',
            'border-width': 4
          }
        },
        {
          selector: 'node.hidden',
          style: {
            'display': 'none'
          }
        },
        {
          selector: 'edge.hidden',
          style: {
            'display': 'none'
          }
        },
        {
          selector: '.highlight',
          style: {
            'line-color': '#f39c12',
            'target-arrow-color': '#f39c12',
            'width': 6
          }
        }
      ],

      // Layout
      layout: {
        name: 'cose', // Force-directed layout
        animate: true,
        animationDuration: 500,
        randomize: false,
        componentSpacing: 100,
        nodeRepulsion: 400000,
        idealEdgeLength: 100,
        edgeElasticity: 100,
        gravity: 0.25
      },

      // Performance
      minZoom: 0.5,
      maxZoom: 3,
      wheelSensitivity: 0.2
    });

    // Track hidden servers for filtering
    let hiddenServers = new Set();

    // Load initial graph data
    async function loadGraph() {
      try {
        const response = await fetch('/api/graph/snapshot');
        const data = await response.json();

        // Transform to Cytoscape format
        const elements = {
          nodes: data.nodes.map(node => ({
            data: {
              id: node.id,
              label: node.label,
              server: node.server,
              pagerank: node.pagerank,
              size: 20 + (node.pagerank * 100), // Node size by PageRank
              color: getServerColor(node.server)
            }
          })),
          edges: data.edges.map(edge => ({
            data: {
              source: edge.source,
              target: edge.target,
              confidence: edge.confidence,
              weight: 1 + (edge.confidence * 5), // Edge width by confidence
              opacity: 0.3 + (edge.confidence * 0.7)
            }
          }))
        };

        cy.add(elements);
        cy.layout({ name: 'cose' }).run();

        // Populate legend
        populateLegend(data.nodes);
      } catch (error) {
        console.error('Failed to load graph:', error);
      }
    }

    // Populate legend with servers
    function populateLegend(nodes) {
      const servers = new Set(nodes.map(n => n.server));
      const legendContainer = document.getElementById('legend');

      servers.forEach(server => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.dataset.server = server;

        const color = document.createElement('div');
        color.className = 'legend-color';
        color.style.backgroundColor = getServerColor(server);

        const label = document.createElement('span');
        label.className = 'legend-label';
        label.textContent = server;

        item.appendChild(color);
        item.appendChild(label);

        // Click to toggle server visibility
        item.addEventListener('click', () => {
          if (hiddenServers.has(server)) {
            hiddenServers.delete(server);
            item.classList.remove('disabled');
            showServer(server);
          } else {
            hiddenServers.add(server);
            item.classList.add('disabled');
            hideServer(server);
          }
        });

        legendContainer.appendChild(item);
      });
    }

    // Hide nodes and edges for a server
    function hideServer(server) {
      cy.nodes().forEach(node => {
        if (node.data('server') === server) {
          node.addClass('hidden');
          node.connectedEdges().addClass('hidden');
        }
      });
    }

    // Show nodes and edges for a server
    function showServer(server) {
      cy.nodes().forEach(node => {
        if (node.data('server') === server) {
          node.removeClass('hidden');
          // Only show edges if both endpoints are visible
          node.connectedEdges().forEach(edge => {
            const source = edge.source();
            const target = edge.target();
            if (!source.hasClass('hidden') && !target.hasClass('hidden')) {
              edge.removeClass('hidden');
            }
          });
        }
      });
    }

    // Real-time updates via SSE
    const eventSource = new EventSource('/events/stream');

    eventSource.addEventListener('edge_created', (event) => {
      const data = JSON.parse(event.data);

      // Check if nodes exist, if not skip
      const sourceNode = cy.getElementById(data.from_tool_id);
      const targetNode = cy.getElementById(data.to_tool_id);
      if (sourceNode.length === 0 || targetNode.length === 0) {
        return;
      }

      // Add new edge with animation
      const newEdge = cy.add({
        data: {
          source: data.from_tool_id,
          target: data.to_tool_id,
          confidence: data.confidence_score,
          weight: 1 + (data.confidence_score * 5),
          opacity: 0.3 + (data.confidence_score * 0.7)
        }
      });

      // Highlight new edge
      newEdge.addClass('highlight');
      setTimeout(() => newEdge.removeClass('highlight'), 2000);
    });

    eventSource.addEventListener('edge_updated', (event) => {
      const data = JSON.parse(event.data);

      // Update edge confidence
      const edge = cy.edges(`[source = "${data.from_tool_id}"][target = "${data.to_tool_id}"]`);
      if (edge.length > 0) {
        edge.data('confidence', data.new_confidence);
        edge.data('weight', 1 + (data.new_confidence * 5));
        edge.data('opacity', 0.3 + (data.new_confidence * 0.7));

        edge.addClass('highlight');
        setTimeout(() => edge.removeClass('highlight'), 1000);
      }
    });

    eventSource.addEventListener('metrics_updated', (event) => {
      const data = JSON.parse(event.data);

      // Update node sizes based on new PageRank
      if (data.pagerank_top_10) {
        data.pagerank_top_10.forEach(({ tool_id, score }) => {
          const node = cy.getElementById(tool_id);
          if (node.length > 0) {
            node.data('pagerank', score);
            node.data('size', 20 + (score * 100));
          }
        });
      }
    });

    eventSource.onerror = (error) => {
      console.error('SSE connection error:', error);
    };

    // Node click handler
    cy.on('tap', 'node', (evt) => {
      const node = evt.target;
      const neighbors = node.neighborhood().nodes();

      showNodeDetails({
        id: node.data('id'),
        label: node.data('label'),
        server: node.data('server'),
        pagerank: node.data('pagerank').toFixed(4),
        degree: node.degree(),
        neighbors: neighbors.map(n => n.data('label'))
      });
    });

    // Show node details panel
    function showNodeDetails(details) {
      document.getElementById('detail-title').textContent = details.label;
      document.getElementById('detail-server').textContent = details.server;
      document.getElementById('detail-pagerank').textContent = details.pagerank;
      document.getElementById('detail-degree').textContent = details.degree;

      const neighborsContainer = document.getElementById('detail-neighbors');
      neighborsContainer.innerHTML = '';
      details.neighbors.forEach(neighbor => {
        const tag = document.createElement('span');
        tag.className = 'neighbor-tag';
        tag.textContent = neighbor;
        neighborsContainer.appendChild(tag);
      });

      document.getElementById('node-details').classList.add('visible');
    }

    // Edge hover tooltip
    let tooltipTimeout;
    cy.on('mouseover', 'edge', (evt) => {
      const edge = evt.target;
      const confidence = edge.data('confidence').toFixed(2);
      const tooltipEl = document.getElementById('tooltip');

      tooltipEl.textContent = `Confidence: ${confidence}`;
      tooltipEl.style.left = evt.renderedPosition.x + 'px';
      tooltipEl.style.top = evt.renderedPosition.y + 'px';
      tooltipEl.classList.add('visible');

      clearTimeout(tooltipTimeout);
    });

    cy.on('mouseout', 'edge', () => {
      tooltipTimeout = setTimeout(() => {
        document.getElementById('tooltip').classList.remove('visible');
      }, 100);
    });

    // Click background to hide node details
    cy.on('tap', (evt) => {
      if (evt.target === cy) {
        document.getElementById('node-details').classList.remove('visible');
      }
    });

    // Initialize
    loadGraph();
  </script>
</body>
</html>
