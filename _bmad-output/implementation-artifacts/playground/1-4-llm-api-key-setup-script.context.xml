<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>LLM API Key Setup Script</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-4-llm-api-key-setup-script.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>playground user</asA>
    <iWant>a simple way to configure my LLM API key</iWant>
    <soThat>I don't have to figure out the configuration myself</soThat>
    <tasks>
      <task id="1" ac="1">
        <title>Create setup script structure</title>
        <subtasks>
          <subtask>Create `playground/scripts/setup-api-key.ts`</subtask>
          <subtask>Implement interactive CLI with prompts (using Deno built-in prompts)</subtask>
          <subtask>Add shebang and make script executable</subtask>
          <subtask>Add help/usage documentation</subtask>
        </subtasks>
      </task>
      <task id="2" ac="2">
        <title>Implement provider detection</title>
        <subtasks>
          <subtask>Import `detectProvider()` from `../lib/llm-provider.ts`</subtask>
          <subtask>Handle detection errors with clear messages</subtask>
          <subtask>Allow manual provider override if detection fails</subtask>
        </subtasks>
      </task>
      <task id="3" ac="3">
        <title>Implement .env file management</title>
        <subtasks>
          <subtask>Read existing `.env` if present</subtask>
          <subtask>Parse existing variables to preserve them</subtask>
          <subtask
          >Write/update the correct provider variable (ANTHROPIC_API_KEY, OPENAI_API_KEY, GOOGLE_API_KEY)</subtask>
          <subtask>Preserve other variables (PORT, SANDBOX_TIMEOUT_MS, etc.)</subtask>
          <subtask>Create backup of existing `.env` before modification</subtask>
        </subtasks>
      </task>
      <task id="4" ac="4">
        <title>Implement API key validation</title>
        <subtasks>
          <subtask>Import `generateCompletion()` from `../lib/llm-provider.ts`</subtask>
          <subtask>Test with minimal prompt ("Say hello in one word")</subtask>
          <subtask>Handle timeout (30s max)</subtask>
          <subtask>Display success with provider and model info</subtask>
        </subtasks>
      </task>
      <task id="5" ac="5">
        <title>Implement error handling</title>
        <subtasks>
          <subtask>Handle invalid key format (detection fails)</subtask>
          <subtask>Handle API errors (authentication failed, rate limit, etc.)</subtask>
          <subtask>Handle network errors (timeout, connection refused)</subtask>
          <subtask>Provide actionable error messages with suggestions</subtask>
        </subtasks>
      </task>
      <task id="6" ac="1-5">
        <title>Add tests</title>
        <subtasks>
          <subtask>Unit tests for .env parsing/writing</subtask>
          <subtask>Unit tests for error handling paths</subtask>
          <subtask>Integration test with mock API responses</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1"
    >`playground/scripts/setup-api-key.ts` script interactif qui guide l'utilisateur</criterion>
    <criterion id="2"
    >Détecte automatiquement le provider depuis le format de la clé (utilise `lib/llm-provider.ts`)</criterion>
    <criterion id="3"
    >Crée ou met à jour le fichier `.env` avec la bonne variable d'environnement</criterion>
    <criterion id="4">Valide que la clé est fonctionnelle avec un test API simple</criterion>
    <criterion id="5"
    >Gère les erreurs gracieusement (clé invalide, format inconnu, échec API)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD-playground.md</path>
        <title>Product Requirements Document - Playground</title>
        <section>Functional Requirements FR004, FR005</section>
        <snippet
        >FR004: L'utilisateur doit pouvoir choisir son provider LLM (OpenAI, Anthropic, Google) via variable d'environnement ou config. FR005: Le système doit auto-détecter le provider depuis le format de la clé API.</snippet>
      </doc>
      <doc>
        <path>docs/epics-playground.md</path>
        <title>Epic Breakdown - Playground</title>
        <section>Story 1.4: LLM API Key Setup Script</section>
        <snippet
        >Script interactif setup-api-key.ts pour guider l'utilisateur. Détection automatique du provider depuis le format de clé. Création/mise à jour du fichier .env avec gestion des erreurs.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-3-workflow-templates-configuration.md</path>
        <title>Story 1.3 - Previous Story Learnings</title>
        <section>Completion Notes</section>
        <snippet
        >Patterns réutilisables: env var pattern avec CAI_DB_PATH, backup strategy avant modification, validation de fonctionnalité réelle (pas juste format), style de documentation pédagogique.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>playground/lib/llm-provider.ts</path>
        <kind>library</kind>
        <symbol
        >detectProvider, generateCompletion, createLLM, getDefaultModel, LLMConfig, LLMProvider</symbol>
        <lines>1-129</lines>
        <reason
        >Core provider detection and API testing logic to import. Provides detectProvider() for key format detection and generateCompletion() for API validation.</reason>
      </artifact>
      <artifact>
        <path>playground/.env.example</path>
        <kind>config-template</kind>
        <symbol
        >ANTHROPIC_API_KEY, OPENAI_API_KEY, GOOGLE_API_KEY, PORT, SANDBOX_TIMEOUT_MS, SANDBOX_MEMORY_LIMIT_MB</symbol>
        <lines>1-17</lines>
        <reason
        >Template reference for .env structure. Shows all variables to preserve when updating.</reason>
      </artifact>
      <artifact>
        <path>playground/server.ts</path>
        <kind>service</kind>
        <symbol>MCP Gateway Server</symbol>
        <lines>1-4848</lines>
        <reason>Reference for how server reads env vars. Shows expected variable names.</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="deno">
        <package name="@std/dotenv" version="0.225.3"
        >Environment file parsing (may use for .env parsing)</package>
        <package name="@ai-sdk/anthropic" version="0.0.39">Anthropic Claude provider</package>
        <package name="@ai-sdk/openai" version="0.0.42">OpenAI GPT provider</package>
        <package name="@ai-sdk/google" version="0.0.35">Google Gemini provider</package>
        <package name="ai" version="3.3.27">Vercel AI SDK core</package>
      </ecosystem>
      <runtime>
        <name>Deno</name>
        <version>2.1.4</version>
        <permissions>--allow-read, --allow-write, --allow-env, --allow-net</permissions>
      </runtime>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture"
    >Deno native - no external CLI frameworks, use built-in prompt()</constraint>
    <constraint type="architecture">File I/O using Deno.readTextFile/writeTextFile</constraint>
    <constraint type="pattern"
    >Backup existing .env before modification (learnings from Story 1.3)</constraint>
    <constraint type="pattern"
    >Environment variable pattern: use same approach as CAI_DB_PATH</constraint>
    <constraint type="pattern">Clear, pedagogical comments and error messages</constraint>
    <constraint type="security"
    >Never log or display full API keys - mask all but last 4 characters</constraint>
    <constraint type="location"
    >Script must be at playground/scripts/setup-api-key.ts (create scripts/ directory)</constraint>
    <constraint type="permissions"
    >Script requires: --allow-read, --allow-write, --allow-env, --allow-net</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>detectProvider</name>
      <kind>function</kind>
      <signature>detectProvider(apiKey: string): LLMProvider</signature>
      <path>playground/lib/llm-provider.ts</path>
      <notes>Returns "openai" | "anthropic" | "google". Throws Error if format unknown.</notes>
    </interface>
    <interface>
      <name>generateCompletion</name>
      <kind>function</kind>
      <signature
      >generateCompletion(config: LLMConfig, prompt: string, options?: { system?: string; maxTokens?: number; temperature?: number }): Promise&lt;{ text: string; usage: any; finishReason: string }&gt;</signature>
      <path>playground/lib/llm-provider.ts</path>
      <notes>Use for API key validation. Minimal prompt: "Say hello in one word".</notes>
    </interface>
    <interface>
      <name>LLMConfig</name>
      <kind>type</kind>
      <signature>{ provider?: LLMProvider; apiKey: string; model?: string }</signature>
      <path>playground/lib/llm-provider.ts</path>
      <notes>Config object for LLM operations. Provider auto-detected if not specified.</notes>
    </interface>
    <interface>
      <name>getDefaultModel</name>
      <kind>function</kind>
      <signature>getDefaultModel(provider: LLMProvider): string</signature>
      <path>playground/lib/llm-provider.ts</path>
      <notes
      >Returns default model string for provider (gpt-4-turbo-preview, claude-3-5-sonnet-20241022, gemini-1.5-pro).</notes>
    </interface>
    <interface>
      <name>Provider Detection Patterns</name>
      <kind>regex-patterns</kind>
      <signature>sk-ant-* → Anthropic, sk-* → OpenAI, AIza* → Google</signature>
      <path>playground/lib/llm-provider.ts:24-28</path>
      <notes>Key format detection logic already implemented in llm-provider.ts.</notes>
    </interface>
    <interface>
      <name>Deno.readTextFile</name>
      <kind>runtime-api</kind>
      <signature>Deno.readTextFile(path: string): Promise&lt;string&gt;</signature>
      <path>Deno runtime</path>
      <notes>Use for reading existing .env file.</notes>
    </interface>
    <interface>
      <name>Deno.writeTextFile</name>
      <kind>runtime-api</kind>
      <signature>Deno.writeTextFile(path: string, data: string): Promise&lt;void&gt;</signature>
      <path>Deno runtime</path>
      <notes>Use for writing .env file and backup.</notes>
    </interface>
    <interface>
      <name>prompt</name>
      <kind>built-in</kind>
      <signature>prompt(message: string, defaultValue?: string): string | null</signature>
      <path>Deno built-in</path>
      <notes>Interactive CLI prompt. Returns null if user cancels (Ctrl+C).</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <paragraph
      >Utilise Deno.test avec assertions @std/assert. Tests unitaires pour les fonctions pures (parsing .env, formatage messages). Tests d'intégration avec mocks pour les appels API. Validation de fichiers réels plutôt que juste formats. Messages d'erreur clairs et actionnables.</paragraph>
    </standards>
    <locations>
      <location>playground/scripts/setup-api-key_test.ts (à créer)</location>
      <location>tests/unit/ (pour tests unitaires partagés)</location>
    </locations>
    <ideas>
      <idea ac="1">Test: Script affiche usage/help avec --help flag</idea>
      <idea ac="1">Test: Script est exécutable (shebang correct)</idea>
      <idea ac="2">Test: detectProvider identifie correctement sk-ant-*, sk-*, AIza*</idea>
      <idea ac="2">Test: Erreur claire si format de clé non reconnu</idea>
      <idea ac="2">Test: Override manuel fonctionne si détection échoue</idea>
      <idea ac="3">Test: Parse .env existant préserve toutes les variables</idea>
      <idea ac="3">Test: Met à jour seulement la variable du provider détecté</idea>
      <idea ac="3">Test: Crée backup .env.backup avant modification</idea>
      <idea ac="3">Test: Crée .env from scratch si n'existe pas</idea>
      <idea ac="4">Test: Validation API avec mock retourne succès</idea>
      <idea ac="4">Test: Timeout après 30s avec message clair</idea>
      <idea ac="4">Test: Affiche provider et model après validation réussie</idea>
      <idea ac="5">Test: Message d'erreur si clé invalide (401)</idea>
      <idea ac="5">Test: Message d'erreur si rate limit (429)</idea>
      <idea ac="5">Test: Message d'erreur si network timeout</idea>
      <idea ac="5">Test: Suggestions incluses dans messages d'erreur</idea>
    </ideas>
  </tests>
</story-context>
